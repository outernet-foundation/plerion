name: Create Deployment PR

on:
  push:
    branches: [feature/data-base-manager]
    paths:
      - ".github/workflows/create-deployment-pr.yml"
      - "scripts/src/build.py"
      - "images.json"
      - "services/**"
      - "tasks/**"
      - "common/**"
      - "!services/api/src/db/migrations/**"

concurrency:
  group: create-deploy-pr
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  id-token: write

env:
  DEPLOY_BRANCH: bot/deploy

jobs:
  prepare:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Ensure remote deploy branch exists
        id: prepare
        run: |
          set -euo pipefail
          if ! git ls-remote --exit-code --heads origin bot/deploy >/dev/null 2>&1; then
            git checkout -B bot/deploy origin/main
            git push origin bot/deploy
          fi

  plan:
    runs-on: ubuntu-latest
    outputs:
      role_arn: ${{ steps.pulumi.outputs.role_arn }}
      names: ${{ steps.plan.outputs.names }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup UV
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: Setup Pulumi
        uses: pulumi/setup-pulumi@v2

      - name: Authenticate Pulumi
        uses: pulumi/auth-actions@v1
        with:
          organization: tyler-s-hatch
          requested-token-type: urn:pulumi:token-type:access_token:personal
          scope: user:tyler-s-hatch

      - name: Get AWS role ARN from Pulumi
        id: pulumi
        working-directory: infra
        run: |
          set -euo pipefail
          ROLE_ARN=$(pulumi stack output --stack core main-prepare-deploy-role-arn)
          echo "role_arn=$ROLE_ARN" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.pulumi.outputs.role_arn }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create plan
        id: plan
        run: |
          set -euo pipefail
          cd scripts
          uv run --locked src/build.py plan --all --output plan.json
          echo Plan:
          jq . plan.json

      - name: Upload plan
        uses: actions/upload-artifact@v4
        with:
          name: plan.json
          path: plan.json

  lock:
    runs-on: ubuntu-latest
    needs: plan

    strategy:
      matrix: ${{ fromJson(needs.plan.outputs.names) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Setup UV
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ needs.plan.outputs.role_arn }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download plan
        uses: actions/download-artifact@v4
        with:
          name: plan.json

      - name: Extract image plan
        run: |
          set -euo pipefail
          jq -c --arg name '${{ matrix }}' '{($name): .[$name]}' plan.json > image-plan.json
          echo "Image plan for ${{ matrix }}:"
          jq . image-plan.json

      - name: Lock image
        run: |
          set -euo pipefail
          cd scripts
          uv run --locked src/build.py lock --plan image-plan.json --cache-type gha > ${{ matrix }}-image-lock.json
          echo "Image lock for ${{ matrix }}:"
          jq . ${{ matrix }}-image-lock.json

      - name: Upload lock snippet
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix }}-image-lock.json
          path: ${{ matrix }}-image-lock.json

  generate-migrations-and-create-deploy-pr:
    runs-on: ubuntu-latest
    needs: lock

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.DEPLOY_BRANCH }}

      - name: Reset deployment branch
        id: reset-deployment-branch
        run: |
          set -euo pipefail
          git checkout -B "${{ env.DEPLOY_BRANCH }}" origin/"${{ github.ref_name }}"
          git reset --hard
          git clean -xfd

      - name: Setup UV
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: Generate migration
        working-directory: services/api
        env:
          PICCOLO_CONF: src.db.local_conf
        run: |
          uv run --locked piccolo migrations new all --auto --auto_input=y || true

      - name: Download lock snippets
        uses: actions/download-artifact@v4
        with:
          pattern: "*-image-lock.json"
          merge-multiple: true
          path: .lock-snippets

      - name: Build image-lock.json
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(.lock-snippets/*.json)
          ((${#files[@]})) || { echo "No snippets; skipping."; exit 0; }
          jq -S -s 'add' <(cat infra/image-lock.json 2>/dev/null || echo '{}') "${files[@]}" \
            > infra/image-lock.json

      - name: Create / update Deploy PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ github.token }}
          branch: ${{ env.DEPLOY_BRANCH }}
          base: ${{ github.ref_name }}
          title: "Deploy (bot)"
          body: "Merging this PR will apply migrations and deploy infra/images."
          commit-message: "chore(deploy): update image-lock.json and migrations"
          add-paths: |
            infra/image-lock.json
            **/migrations/*.py
