name: Create Deployment PR

on:
  push:
    branches: [feature/ci]
    paths:
      - ".github/workflows/create-deployment-pr.yml"
      - "scripts/src/scripts/build.py"
      - "images.json"
      - "docker/**"
      - "packages/**"

concurrency:
  group: create-deploy-pr
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  id-token: write
  packages: write

env:
  DEPLOY_BRANCH: bot/deploy

jobs:
  prepare:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Ensure remote deploy branch exists
        id: prepare
        run: |
          set -euo pipefail
          if ! git ls-remote --exit-code --heads origin bot/deploy >/dev/null 2>&1; then
            git checkout -B bot/deploy origin/main
            git push origin bot/deploy
          fi

  plan:
    runs-on: ubuntu-latest
    outputs:
      names: ${{ steps.plan.outputs.names }}
      needs_lock: ${{ steps.plan.outputs.needs_lock }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup UV
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: Create plan
        id: plan
        run: |
          set -euo pipefail

          # Create image build plan
          # cd scripts
          # uv run --locked src/build.py plan --all --output plan.json
          uv run --project scripts build plan --output plan.json

          # Echo plan json for logging
          echo Plan:
          jq . plan.json

          # Extract names from plan (or set to __EMPTY__ if no images to build)
          if [ "$(jq 'keys|length' plan.json)" -eq 0 ]; then
            echo 'needs_lock=false' >> "$GITHUB_OUTPUT"
            echo 'names={"name":["__EMPTY__"]}' >> "$GITHUB_OUTPUT"
          else
            echo 'needs_lock=true' >> "$GITHUB_OUTPUT"
            echo "names=$(jq -c '{name: keys}' plan.json)" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload plan
        uses: actions/upload-artifact@v4
        with:
          name: plan.json
          path: plan.json

  lock:
    runs-on: ubuntu-latest
    needs: plan
    if: ${{ needs.plan.outputs.needs_lock == 'true' }}

    strategy:
      matrix: ${{ fromJson(needs.plan.outputs.names) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Setup UV
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: Free disk space (runner)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download plan
        uses: actions/download-artifact@v4
        with:
          name: plan.json

      - name: Extract image plan
        run: |
          set -euo pipefail

          # Extract plan for this image
          jq -c --arg name '${{ matrix.name }}' '{($name): .[$name]}' plan.json > image-plan.json

          # Echo plan json for logging
          echo "Image plan for ${{ matrix.name }}:"
          jq . image-plan.json

      # Require for layer caching
      - name: Setup GitHub Runtime
        uses: crazy-max/ghaction-github-runtime@v3

      - name: Lock image
        run: |
          set -euo pipefail

          # Require for layer caching
          docker buildx create --use --driver docker-container

          # Lock image
          # cd scripts
          # uv run --locked src/build.py lock --plan image-plan.json --cache-type gha --output ${{ matrix.name }}-image-lock.json
          uv run --project scripts build lock --plan image-plan.json --cache-type gha --output ${{ matrix.name }}-image-lock.json
          # Echo lock json for logging
          echo "Image lock for ${{ matrix.name }}:"
          jq . ${{ matrix.name }}-image-lock.json

      - name: Upload image lock artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-image-lock.json
          path: ${{ matrix.name }}-image-lock.json
