name: Create Deployment PR

on:
  push:
    branches: [main]

concurrency:
  group: create-deploy-pr
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  id-token: write

env:
  DEPLOY_BRANCH: bot/deploy

jobs:

  prepare-deployment-branch:

    runs-on: ubuntu-latest

    outputs:
      sha: ${{ steps.prepare-deployment-branch.outputs.sha }}

    steps:

      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Prepare deployment branch
        id: prepare-deployment-branch
        run: |
          git config user.name  "ci-bot"
          git config user.email "ci-bot@yourcompany.com"
          git checkout -B "${{ env.DEPLOY_BRANCH }}" "${{ github.ref_name }}"
          git push --force-with-lease origin "${{ env.DEPLOY_BRANCH }}"
          echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
      
  build-and-push-images:

    runs-on: ubuntu-latest
    needs: prepare-deployment-branch

    strategy:
      matrix:
        services:
          - { name: "api",              context: "./services/api",               stack: "dev"  }
          - { name: "cloudbeaver-init", context: "./services/cloudbeaver-init", stack: "dev"  }
          - { name: "tailscale-beacon", context: "./services/tailscale-beacon",  stack: "core" }
        
    steps:

      - uses: actions/checkout@v4
        with: 
          fetch-depth: 0
          ref: ${{ env.DEPLOY_BRANCH }}

      - name: Install Pulumi CLI
        uses: pulumi/setup-pulumi@v2

      - name: Authenticate with Pulumi (OIDC)
        uses: pulumi/auth-actions@v1
        with:
          organization: tyler-s-hatch
          requested-token-type: urn:pulumi:token-type:access_token:personal
          scope: user:tyler-s-hatch

      - name: Get Pulumi stack outputs
        id: pulumi-stack-outputs
        working-directory: infra
        shell: bash
        run: |
          set -euo pipefail
          REPO_URL=$(pulumi stack output --stack ${{ matrix.services.stack }} ${{ matrix.services.name }}-image-repo-url)
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "role_arn=$(pulumi stack output --stack ${{ matrix.services.stack }} ${{ matrix.services.name }}-image-repo-role-arn)" >> $GITHUB_OUTPUT
          echo "region=$(sed -n 's#.*\.dkr\.ecr\.\([^.]*\)\.amazonaws\.com/.*#\1#p' <<<"$REPO_URL")" >> $GITHUB_OUTPUT

      - name: Authenticate with AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.pulumi-stack-outputs.outputs.role_arn }}
          aws-region: ${{ steps.pulumi-stack-outputs.outputs.region }}

      - name: Authenticate with ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        id: build-and-push
        shell: bash
        run: |
          set -euo pipefail
          IMAGE="${{ steps.pulumi-stack-outputs.outputs.repo_url }}:git-${{ needs.prepare-deployment-branch.outputs.sha }}"
          echo "Building $IMAGE from ${{ matrix.services.context }}"
          docker build -t "$IMAGE" "${{ matrix.services.context }}"
          docker push "$IMAGE"
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE")
          
          # Set outputs for later use
          echo "repo_digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "service=${{ matrix.services.name }}" >> $GITHUB_OUTPUT
          echo "tag=git-${{ needs.prepare-deployment-branch.outputs.sha }}" >> $GITHUB_OUTPUT

      - name: Write image lock json
        run: |
          jq -n \
            --arg service "${{ matrix.services.name }}" \
            --arg tag "git-${{ needs.prepare-deployment-branch.outputs.sha }}" \
            --arg repo_digest "${{ steps.build-and-push.outputs.repo_digest }}" \
            '{($service): {tag:$tag, repo_digest:$repo_digest}}' \
            > "lock-${{ matrix.services.name }}.json"

      - uses: actions/upload-artifact@v4
        with:
          name: lock-snippet-${{ matrix.services.name }}
          path: lock-${{ matrix.services.name }}.json

  generate-migrations-and-create-deploy-pr:

    runs-on: self-hosted # required in order for piccolo to connect to postgres
    needs: build-and-push-images
      
    steps:

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.DEPLOY_BRANCH }}

      - name: Install Pulumi CLI
        uses: pulumi/setup-pulumi@v2

      - name: Authenticate with Pulumi (OIDC)
        uses: pulumi/auth-actions@v1
        with:
          organization: tyler-s-hatch
          requested-token-type: urn:pulumi:token-type:access_token:personal
          scope: user:tyler-s-hatch

      # - uses: pulumi/esc-action@v1
      #   id: esc
      #   with:
      #     environment: tyler-s-hatch/plerion/core

      # - name: Generate GitHub App Token
      #   id: generate_token
      #   uses: actions/create-github-app-token@v1
      #   with:
      #     app-id: ${{ steps.esc.outputs.github-app-id }}
      #     private-key: ${{ steps.esc.outputs.github-app-private-key }}

      - name: Get Pulumi stack outputs
        id: pulumi-outputs
        working-directory: infra
        shell: bash
        run: |
          set -euo pipefail
          echo "postgres_dsn_secret_arn=$(pulumi stack output --stack dev postgres-dsn-secret-arn)" >> $GITHUB_OUTPUT
          echo "role_arn=$(pulumi stack output --stack dev postgres-migrations-role-arn)" >> $GITHUB_OUTPUT

      - name: Configure AWS creds for SecretsManager
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.pulumi-outputs.outputs.role_arn }}
          aws-region: us-east-1

      - name: Fetch Postgres DSN secret
        id: get-postgres-dsn
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: POSTGRES_DSN,${{ steps.pulumi-outputs.outputs.postgres_dsn_secret_arn }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install UV
        run: |
          pip install uv --root-user-action=ignore

      - name: Install dependencies
        working-directory: services/api
        run: |
          uv sync --frozen

      - name: Generate migration
        working-directory: services/api
        run: |
          export PICCOLO_CONF=src.db.conf
          uv run piccolo migrations new all --auto --auto_input=y || true

      - uses: actions/download-artifact@v4
        with:
          pattern: lock-snippet-*
          merge-multiple: true
          path: .lock-snippets

      - name: Build image-lock.json
        run: |
          mkdir -p deploy
          jq -s 'reduce .[] as $i ({}; . * $i)' .lock-snippets/*.json > deploy/image-lock.json
          echo "Final lock file:"
          cat deploy/image-lock.json

      - name: Commit lock file + migrations
        run: |
          set -e
          git config user.name  "ci-bot"
          git config user.email "ci-bot@yourcompany.com"

          git add deploy/image-lock.json
          git add -A **/migrations/*.py || true

          if ! git diff --cached --quiet; then
            git commit -m "chore(deploy): update image-lock.json and migrations"
            git push --force-with-lease origin ${{ env.DEPLOY_BRANCH }}
          else
            echo "No changes to lock file or migrations"
          fi

      - name: Open / refresh Deploy PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          TITLE="Deploy (bot)"
          BODY="Merging this PR will apply migrations and deploy infra/images."

          if gh pr view ${{ env.DEPLOY_BRANCH }} --base main >/dev/null 2>&1; then
            gh pr edit ${{ env.DEPLOY_BRANCH }} --base main --title "$TITLE" --body "$BODY"
          else
            gh pr create --head ${{ env.DEPLOY_BRANCH }} --base main --title "$TITLE" --body "$BODY"
          fi